---
# install latest prometheus
- name: create prometheus data dir
  file: 
    path: '/var/lib/prometheus/'
    state: directory
    owner: prometheus
    group: prometheus

- name: get prometheus latest version
  uri:
    url: "https://raw.githubusercontent.com/prometheus/prometheus/main/VERSION"
    return_content: true
    status_code: 200
  register: latest_prom

- name: trim var
  set_fact:
    prom_version: '{{ latest_prom.content | trim }}'

- name: download prometheus latest 
  get_url: 
    url: "https://github.com/prometheus/prometheus/releases/download/v{{ prom_version }}/prometheus-{{ prom_version }}.linux-amd64.tar.gz"
    dest: '/tmp/prometheus-{{ prom_version }}.linux-amd64.tar.gz'
    owner: prometheus
    group: prometheus
    mode: 0644

- name: untar prometheus archive
  unarchive:
    src: '/tmp/prometheus-{{ prom_version }}.linux-amd64.tar.gz'
    dest: '/tmp/'
    owner: prometheus
    group: prometheus
    mode: 0644    
    creates: '/tmp/prometheus-{{ prom_version }}.linux-amd64/'

- name: moving prometheus to etc
  copy:
    src: '/tmp/prometheus-{{ prom_version }}.linux-amd64/'
    dest: '/etc/prometheus/'
    mode: 0755
    owner: prometheus
    group: prometheus

- name: moving prometheus binary to path
  copy: 
    src: '/etc/prometheus/prometheus'
    dest: '/usr/local/bin/prometheus'
    mode: 0755
    owner: prometheus
    group: prometheus

- name: moving promtool binary to path
  copy: 
    src: '/etc/prometheus/promtool'
    dest: '/usr/local/bin/promtool'
    mode: 0755
    owner: prometheus
    group: prometheus

- name: create rules and targets directories
  file: 
    path: 
      - /etc/prometheus/file_sd_targets/
      - /etc/prometheus/rules/
    state: directory
    mode: 0755
    owner: prometheus
    group: prometheus

- name: remove binaries from etc directory
  file: 
    path:
      - "/etc/prometheus/prometheus"
      - "/etc/prometheus/promtool"
    state: absent
