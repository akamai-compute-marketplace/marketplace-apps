---
# install latest prometheus
- name: create prometheus dirs
  file: 
    path: 
      - /etc/prometheus/file_sd_targets
      - /var/lib/prometheus
    state: directory
    owner: prometheus
    group: prometheus

- name: get prometheus latest
  uri:
    url: "https://raw.githubusercontent.com/prometheus/prometheus/main/VERSION"
    return_content: true
    status_code: 200
  register: latest_prom

- name: download prometheus latest 
  get_url: 
    url: "https://github.com/prometheus/prometheus/releases/download/v{{ latest_prom.content }}/prometheus-{{ latest_prom.content }}.linux-amd64.tar.gz"
    dest: "/tmp/prometheus-{{ latest_prom.content }}.linux-amd64.tar.gz"
    owner: prometheus
    group: prometheus
    mode: 0644

- name: untar prometheus archive
  unarchive:
    src: "/tmp/prometheus-{{ latest_prom.content }}.linux-amd64.tar.gz"
    dest: "/tmp"
    owner: prometheus
    group: prometheus
    mode: 0644    
    creates: "/tmp/prometheus-{{ latest_prom.content }}.linux-amd64/prometheus"

- name: moving prometheus to etc
  copy:
    src: "/tmp/prometheus-{{ latest_prom.content }}.linux-amd64/prometheus"
    dest: "/etc/prometheus"
    mode: 0755
    owner: prometheus
    group: prometheus

- name: moving prometheus binaries to path
  copy: 
    src: "/etc/prometheus/{{ item.src }}"
    dest: "{{ item.dest }}"
  loop: 
    - '{{ src: prometheus dest: /usr/local/bin/prometheus }}'
    - '{{ src: promtool dest: /usr/local/bin/promtool }}'

- name: remove binaries from etc directory
  file: 
    path:
      - "/etc/prometheus/prometheus"
      - "/etc/prometheus/promtool"
    state: absent
