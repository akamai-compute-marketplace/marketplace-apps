---
# install loki datasource

- name: confirm grafana is ready
  wait_for:
    host: localhost
    port: 3000
    sleep: 5
    timeout: 60

- name: create json payload file for loki datasource
  template:
    src: 'templates/loki_datasource.json.j2'
    dest: '/tmp/loki_datasource.json'

- name: add loki datasource
  uri:
    url: 'http://localhost:3000/api/datasources'
    method: POST
    url_username: 'admin'
    url_password: '{{ grafana_password }}'
    force_basic_auth: true
    headers:
      Content-Type: application/json
    src: /tmp/loki_datasource.json
  no_log: true

- name: clean up /tmp directory
  file:
    path: '/tmp/loki_datasource.json'
    state: absent