---
- name: Set WireGuard Client directory path
  set_fact:
    wireguard_dir: /etc/wireguard

- name: Install WireGuard
  apt:
    name: wireguard
    state: present
    update_cache: true

- name: Generate WireGuard client private key
  command: wg genkey
  register: wg_private_key

- name: Save WireGuard client private key
  copy:
    content: "{{ wg_private_key.stdout }}"
    dest: "{{ wireguard_dir }}/client_private.key"
    mode: '0600'

- name: Generate WireGuard client public key from private key
  command: wg pubkey
  args:
    stdin: "{{ wg_private_key.stdout }}"
  register: wg_public_key

- name: Save WireGuard client public key
  copy:
    content: "{{ wg_public_key.stdout }}\n"
    dest: "{{ wireguard_dir }}/client_public.key"
    mode: '0644'

- name: Create WireGuard config from template
  template:
    src: wg0.conf.j2
    dest: "{{ wireguard_dir }}/wg0.conf"
    mode: '0600'
  vars:
    client_private_key: "{{ wg_private_key.stdout }}"

- name: Enable and start WireGuard
  systemd:
    name: wg-quick@wg0
    enabled: true
    state: started
