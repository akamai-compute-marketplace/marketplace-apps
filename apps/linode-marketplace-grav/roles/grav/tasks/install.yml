---
- name: Install required packages for Grav
  apt:
    name:
      - php-fpm
      - php-cli
      - php-gd
      - php-curl
      - php-mbstring
      - php-xml
      - php-zip
      - php-apcu
      - php-intl
      - php8.3-yaml
      - php8.3-memcached
      - php8.3-memcache
      - memcached
      - git
    state: present
    update_cache: yes

- name: Configure PHP settings
  lineinfile:
    path: /etc/php/8.3/fpm/php.ini
    regexp: ';cgi.fix_pathinfo=1'
    line: 'cgi.fix_pathinfo=0'
  notify: restart php8.3-fpm

# - name: Create grav user
#   user:
#     name: grav
#     shell: /bin/bash
#     groups: sudo
#     append: true
#     home: /home/grav
#     create_home: yes

- name: Create web directory with proper ownership
  file:
    path: /var/www/grav
    state: directory
    mode: '0755'
    owner: www-data
    group: www-data

- name: Install Composer for www-data user
  become: yes
  become_user: www-data
  block:
    - name: Download Composer installer
      get_url:
        url: https://getcomposer.org/installer
        dest: /tmp/composer-setup.php
        mode: '0755'

    - name: Create .local/bin directory
      file:
        path: /home/www-data/.local/bin
        state: directory
        mode: '0755'

    - name: Install Composer locally
      shell: php /tmp/composer-setup.php --install-dir=/home/www-data/.local/bin --filename=composer
      args:


- name: Clone and install Grav as www-data user
  block:
    - name: Clone Grav repository
      git:
        repo: https://github.com/getgrav/grav.git
        dest: /var/www/grav
        depth: 1

    # - name: Install Grav dependencies with Composer
    #   shell: /home/grav/.local/bin/composer install --no-dev -o
    #   args:
    #     chdir: /var/www/grav

    # - name: Install Grav core
    #   shell: bin/grav install
    #   args:
    #     chdir: /var/www/grav

    # - name: Install Grav admin plugin
    #   shell: echo 'y' | bin/gpm install admin
    #   args:
    #     chdir: /var/www/grav

    - name: Install Grav dependencies with Composer
      expect:
        command: /home/www-data/.local/bin/composer install --no-dev -o
        chdir: /var/www/grav
        responses:
          (?i)Do you want to continue: "yes"
        timeout: 300

    - name: Install Grav core
      expect:
        command: bin/grav install
        chdir: /var/www/grav
        responses:
          (?i)Do you want to continue: "yes"
        timeout: 300

    - name: Install Grav admin plugin
      expect:
        command: bin/gpm install admin
        chdir: /var/www/grav
        responses:
          (?i)Do you want to continue: "yes"
          (?i)Do you want to install: "yes"
        timeout: 300
  become: yes
  # become_user: grav
  become_user: www-data
        
- name: Make bin files executable
  file:
    path: "/var/www/grav/bin/{{ item }}"
    mode: '0755'
  loop:
    - gpm
    - grav
    - plugin

- name: Ensure Grav directories have correct permissions
  file:
    path: "/var/www/grav/{{ item }}"
    state: directory
    mode: '0775'
    # owner: grav
    owner: www-data
    group: www-data
    recurse: yes
  loop:
    - cache
    - logs
    - images
    - user/data
    - user/config
    - user/pages
    - tmp
    - backup
    - assets
    - user/accounts

- name: Create admin account directory
  # become: yes
  file:
    path: /var/www/grav/user/accounts
    state: directory
    mode: '0775'
    # owner: grav
    owner: www-data
    group: www-data

- name: Deploy admin account configuration
  # become: yes
  template:
    src: admin.yaml.j2
    dest: /var/www/grav/user/accounts/admin.yaml
    # owner: grav
    owner: www-data
    group: www-data
    mode: '0644'

- name: Update cache driver to Redis in system.yaml
  lineinfile:
    path: /var/www/grav/user/config/system.yaml
    regexp: '^\s*driver: auto'
    line: '  driver: redis'
    state: present
    backrefs: yes
  # become: yes
  # become_user: grav
  # notify: restart php8.3-fpm

- name: Clear Grav cache
  command: bin/grav clearcache
  args:
    chdir: /var/www/grav
  become: yes
  become_user: www-data