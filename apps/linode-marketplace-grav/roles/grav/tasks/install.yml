---
- name: Install required packages for Grav
  apt:
    name:
      - php-fpm
      - php-cli
      - php-gd
      - php-curl
      - php-mbstring
      - php-xml
      - php-zip
      - php-apcu
      - php8.3-yaml
      - php8.3-redis
      - redis-server
      - php8.3-memcached
      - memcached
      - git
      - composer
    state: present
    update_cache: yes

- name: Configure PHP settings
  lineinfile:
    path: /etc/php/8.3/fpm/php.ini
    regexp: ';cgi.fix_pathinfo=1'
    line: 'cgi.fix_pathinfo=0'
  notify: restart php8.3-fpm

- name: Create grav user
  user:
    name: grav
    shell: /bin/bash
    groups: sudo
    append: true

- name: Generate hashed password for Grav admin
  set_fact:
    hashed_admin_password: "{{ grav_admin_password | password_hash('bcrypt', lookup('password', '/dev/null chars=ascii_letters,digits length=22'), rounds=10) }}"
  no_log: true

- name: Create web directory with proper ownership
  file:
    path: /var/www/grav
    state: directory
    mode: '0755'

- name: Clone Grav repository
  git:
    repo: https://github.com/getgrav/grav.git
    dest: /var/www/grav
    depth: 1

- name: Install Grav dependencies with Composer
  shell: composer install --no-dev -o
  args:
    chdir: /var/www/grav

- name: Install Grav core
  shell: bin/grav install
  args:
    chdir: /var/www/grav

- name: Install Grav admin plugin
  shell: bin/gpm install admin
  args:
    chdir: /var/www/grav

- name: Set directory permissions
  ansible.builtin.file:
    path: /var/www/grav
    state: directory
    recurse: yes
    mode: '0755'
    owner: grav
    group: www-data

- name: Set file permissions
  ansible.builtin.find:
    paths: /var/www/grav
    file_type: file
    # recurse: yes
  # register: grav_files

# - name: Apply file permissions
#   ansible.builtin.file:
#     path: "{{ item.path }}"
#     mode: '0644'
#     owner: grav
#     group: www-data
#   with_items: "{{ grav_files.files }}"

- name: Make bin files executable
  ansible.builtin.file:
    path: "{{ item }}"
    mode: '0755'
    owner: grav
    group: www-data
  with_fileglob:
    - "/var/www/grav/bin/*"

- name: Create admin account directory
  file:
    path: /var/www/grav/user/accounts
    state: directory
    mode: '0775'
    owner: grav
    group: www-data

- name: Deploy admin account configuration
  template:
    src: admin.yaml.j2
    dest: /var/www/grav/user/accounts/admin.yaml
    owner: grav
    group: www-data
    mode: '0644'
