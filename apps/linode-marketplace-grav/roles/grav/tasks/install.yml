---
- name: Install required packages for Grav
  apt:
    name:
      - php-fpm
      - php-cli
      - php-gd
      - php-curl
      - php-mbstring
      - php-xml
      - php-zip
      - php-apcu
      - php8.3-yaml
      - php8.3-redis
      - redis-server
      - php8.3-memcached
      - memcached
      - git
      - composer
    state: present
    update_cache: yes

- name: Configure PHP settings
  lineinfile:
    path: /etc/php/8.3/fpm/php.ini
    regexp: ';cgi.fix_pathinfo=1'
    line: 'cgi.fix_pathinfo=0'
  notify: restart php8.3-fpm

- name: Create grav user
  user:
    name: grav
    shell: /bin/bash
    groups: sudo
    append: true

- name: Generate hashed password for Grav admin
  community.crypto.password_hash:
    name: "{{ grav_admin_password }}"
    salt: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=16') }}"
    hash: "bcrypt"
    rounds: 10
  register: password_hash_result
  no_log: true

- name: Set hashed password variable
  set_fact:
    hashed_admin_password: "{{ password_hash_result.password }}"
  no_log: true

- name: Create web directory
  file:
    path: /var/www/grav
    state: directory
    mode: '0755'

- name: Clone Grav repository
  git:
    repo: https://github.com/getgrav/grav.git
    dest: /var/www/grav
    depth: 1

- name: Install Grav dependencies with Composer
  community.general.composer:
    command: install
    arguments: --no-dev -o
    working_dir: /var/www/grav
  become: yes
  become_user: grav

- name: Install Grav core
  command: bin/grav install
  args:
    chdir: /var/www/grav
    creates: /var/www/grav/user/config/system.yaml
  become: yes
  become_user: grav

- name: Install Grav admin plugin
  command: bin/gpm install admin
  args:
    chdir: /var/www/grav
    creates: /var/www/grav/user/plugins/admin/admin.php
  become: yes
  become_user: grav

- name: Set directory permissions
  ansible.builtin.file:
    path: /var/www/grav
    state: directory
    recurse: yes
    mode: '0755'
    owner: grav
    group: www-data
    
- name: Set file permissions
  ansible.builtin.find:
    paths: /var/www/grav
    file_type: file
    recurse: yes
  register: grav_files

- name: Apply file permissions
  ansible.builtin.file:
    path: "{{ item.path }}"
    mode: '0644'
    owner: grav
    group: www-data
  with_items: "{{ grav_files.files }}"

- name: Make bin files executable
  ansible.builtin.file:
    path: "{{ item }}"
    mode: '0755'
    owner: grav
    group: www-data
  with_fileglob:
    - "/var/www/grav/bin/*"

- name: Create admin account directory
  file:
    path: /var/www/grav/user/accounts
    state: directory
    mode: '0775'
    owner: grav
    group: www-data

- name: Deploy admin account configuration
  template:
    src: admin.yaml.j2
    dest: /var/www/grav/user/accounts/admin.yaml
    owner: grav
    group: www-data
    mode: '0644'
