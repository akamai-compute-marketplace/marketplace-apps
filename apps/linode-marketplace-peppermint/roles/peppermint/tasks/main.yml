---
- name: Peppermint Config and Start
  block:
  - name: Configure service file 
    lineinfile:
      path: "/etc/systemd/system/peppermint.service"
      create: yes
      line: "{{item}}"
    loop:
    - "[Unit]"
    - "Description=Docker Compose Peppermint Application Service"
    - "Requires=peppermint.service"
    - "After=peppermint.service"
    - "[Service]"
    - "Type=oneshot"
    - "RemainAfterExit=yes"
    - "ExecStart=/usr/local/bin/docker-compose up -d"
    - "ExecStop=/usr/local/bin/docker-compose down"
    - "ExecReload=/usr/local/bin/docker-compose up -d"
    - "WorkingDirectory=/etc/docker/compose/peppermint/"
    - "[Install]"
    - "WantedBy=multi-user.target"
  - name: Create a symbolic link for docker-compose
    file:
      src: /usr/bin/docker-compose
      dest: /usr/local/bin/docker-compose
      state: link
    become: true
  - name: Create Docker Compose Directory
    file:
      path: /etc/docker/compose/peppermint/
      state: directory
  - name: Get Docker Compose File
    get_url:
      url: "https://raw.githubusercontent.com/Peppermint-Lab/Peppermint/master/docker-compose.yml"
      dest: "/etc/docker/compose/peppermint/docker-compose.yml"
  - name: Get Docker Compose File
    replace:
      path: /etc/docker/compose/peppermint/docker-compose.yml
      regexp: 'localhost'
      replace: '{{ ansible_default_ipv4.address }}'
  - name: Reload systemd daemon
    systemd:
      name: peppermint.service
      state: reloaded
  - name: Enable Peppermint Service
    systemd:
      name: peppermint.service
      enabled: yes
  - name: Start Peppermint Service
    systemd:
      name: peppermint.service
      state: started