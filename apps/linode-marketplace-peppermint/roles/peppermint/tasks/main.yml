---
- name: Peppermint Config and Start
  block:
  - name: Configure service file 
    lineinfile:
      path: "/etc/systemd/system/peppermint.service"
      create: yes
      line: "{{item}}"
    loop:
    - "[Unit]"
    - "Description=Docker Compose Peppermint Application Service"
    - "Requires=peppermint.service"
    - "After=peppermint.service"
    - "[Service]"
    - "Type=oneshot"
    - "RemainAfterExit=yes"
    - "ExecStart=/usr/bin/docker-compose up -d"
    - "ExecStop=/usr/bin/docker-compose down"
    - "ExecReload=/usr/bin/docker-compose up -d"
    - "WorkingDirectory=/etc/docker/compose/peppermint/"
    - "[Install]"
    - "WantedBy=multi-user.target"
  - name: Create Docker Compose Directory
    file:
      path: /etc/docker/compose/peppermint/
      state: directory
  - name: Create Docker Compose File
    lineinfile:
      path: "/etc/docker/compose/peppermint/docker-compose.yml"
      create: yes
      line: "{{item}}"
    loop:
    - 'version: "3.1"'
    - ''
    - 'services:'
    - '  postgres:'
    - '    container_name: postgres'
    - '    image: postgres:latest'
    - '    restart: always'
    - '    volumes:'
    - '      - ./docker-data/db:/data/db'
    - '    environment:'
    - '      POSTGRES_USER: peppermint'
    - '      POSTGRES_PASSWORD: 1234'
    - '      POSTGRES_DB: peppermint'
    - ''
    - '  client:'
    - '    container_name: peppermint'
    - '    image: pepperlabs/peppermint:latest'
    - '    ports:'
    - '      - 5000:5000'
    - '    restart: on-failure'
    - '    depends_on:'
    - '      - postgres'
    - '    environment:'
    - '      PORT: 5000'
    - '      DB_USERNAME: peppermint'
    - '      DB_PASSWORD: 1234'
    - '      DB_HOST: "postgres"'
    - '      BASE_URL: "http://localhost:5000"'
  - name: Change Docker Compose localhost to ip
    replace:
      path: /etc/docker/compose/peppermint/docker-compose.yml
      regexp: 'localhost'
      replace: '{{ ansible_default_ipv4.address }}'
  - name: Reload systemd daemon
    systemd:
      daemon_reload: yes
  - name: Enable Peppermint Service
    systemd:
      name: peppermint.service
      enabled: yes
  - name: Start Peppermint Service
    systemd:
      name: peppermint.service
      state: started