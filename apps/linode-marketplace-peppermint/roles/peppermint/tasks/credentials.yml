---
- name: wait for peppermint container to be healthy
  community.docker.docker_container_info:
    name: peppermint
  register: peppermint_container
  until: >
    peppermint_container.container.State.Running == true and
    (peppermint_container.container.State.Health.Status == 'healthy' or
     peppermint_container.container.State.Health is not defined)
  retries: 30
  delay: 10

- name: wait for database initialization and default user creation
  pause:
    seconds: 20

- name: generate bcrypt hash for admin password
  set_fact:
    peppermint_admin_password_hash: "{{ peppermint_admin_password | password_hash('bcrypt', lookup('password', '/dev/null chars=ascii_letters,digits length=22'), rounds=10) }}"
  no_log: true

- name: update peppermint admin password in database
  community.docker.docker_container_exec:
    container: peppermint_postgres
    command: >
      psql -U peppermint -d peppermint -c
      "UPDATE \"User\"
       SET password = '{{ peppermint_admin_password_hash }}',
           \"updatedAt\" = CURRENT_TIMESTAMP
       WHERE email = 'admin@admin.com';"
    env:
      PGPASSWORD: "{{ postgres_password }}"
  no_log: true

- name: verify password was updated
  community.docker.docker_container_exec:
    container: peppermint_postgres
    command: >
      psql -U peppermint -d peppermint -t -c
      "SELECT COUNT(*) FROM \"User\" WHERE email = 'admin@admin.com';"
    env:
      PGPASSWORD: "{{ postgres_password }}"
  register: password_verify
  failed_when: password_verify.stdout | trim != '1'
