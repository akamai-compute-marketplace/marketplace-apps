---
# apps/linode_helpers/roles/certbot_ssl/tasks/apache-certbot.yml
- name: install python3-certbot
  apt:
    name: python3-certbot
    state: present

- name: set certbot plugin
  set_fact:
    certbot_plugin: standalone
    cacheable: yes

- name:  dry-run certbot
  include_tasks: dry-run.yml
  vars:
    webserver: standalone
    
# get certs
- name: installing let's encrypt certificate on subdomain provided via UDF
  shell:
    cmd: "certbot -n --standalone --agree-tos --redirect certonly -d {{ subdomain }}.{{ domain }} -m {{ soa_email_address }}"
  when: 
    - domain is defined
    - subdomain != 'www'

- name: installing let's encrypt certificate on tld and default subdomain provided via UDF
  shell: 
    cmd: "certbot -n --standalone --agree-tos --redirect certonly -d {{ domain }} -d {{ subdomain }}.{{ domain }} -m {{ soa_email_address }}"
  when:
    - domain is defined
    - subdomain == 'www'

- name: installing let's encrypt certificate on default domain
  shell:
    cmd: "certbot -n --standalone --agree-tos --redirect certonly -d {{ default_dns }} -m {{ soa_email_address }}"
  when: default_dns is defined