#!/bin/bash
# Log File
LOG_FILE="/var/log/marketplace_addons.log"

echo "=================================================" | tee -a "$LOG_FILE"
echo " New Relic Installation - License Key Setup" | tee -a "$LOG_FILE"
echo "=================================================" | tee -a "$LOG_FILE"
echo ""

# Loop until a valid license key is provided
while true; do
    echo ""
    echo "If you don't have a NewRelic API token, visit:" | tee -a "$LOG_FILE"
    echo "  https://one.newrelic.com/admin-portal/api-keys/ to generate one" | tee -a "$LOG_FILE"
    echo ""
    read -s -p "Enter your New Relic license key: " NEWRELIC_KEY

    # Validate the token via New Relic API
    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
        -H "Api-Key: $NEWRELIC_KEY" \
        https://api.newrelic.com/v2/applications.json)

    if [ "$HTTP_CODE" -eq 200 ]; then
        newrelic config set --apiKey $NEWRELIC_KEY
        newrelic config list

        echo "$(date) - License added to New Relic" | tee -a "$LOG_FILE"
        break
    else
        echo "$(date) - Invalid New Relic license key. Please try again." | tee -a "$LOG_FILE"
    fi
done

# Clean up
rm /etc/profile.d/newrelic.sh
