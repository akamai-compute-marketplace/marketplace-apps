---
- name: Install Kali XFCE and VNC packages
  apt:
    name:
      - kali-desktop-xfce
      - dbus-x11
      - tigervnc-standalone-server
      - expect
      - lightdm
    state: present
  environment:
    DEBIAN_FRONTEND: noninteractive

- name: Configure lightdm as default display manager
  debconf:
    name: lightdm
    question: shared/default-x-display-manager
    value: lightdm
    vtype: select

- name: Set Xfce as default session manager
  command: update-alternatives --set x-session-manager /usr/bin/xfce4-session
  changed_when: true

- name: Create VNC user
  user:
    name: "{{ vnc_username }}"
    password: "{{ vnc_password | password_hash('sha512') }}"
    shell: /bin/bash

- name: Set up VNC password
  expect:
    command: vncserver
    responses:
      Password: "{{ vnc_password }}"
      Verify: "{{ vnc_password }}"
      "Would you like to enter a view-only password (y/n)?": "n"
  become: yes
  become_user: "{{ vnc_username }}"
  no_log: true

- name: Check if VNC is running
  command: pgrep Xtigervnc
  register: vnc_running
  ignore_errors: true # ignore if no process is running

- name: Kill existing VNC process
  command: killall Xtigervnc
  when: vnc_running.rc == 0 # only kill if VNC is running

- name: Create VNC service file
  template:
    src: vncserver@.service.j2
    dest: /etc/systemd/system/vncserver@.service
    mode: '0644'

- name: Start and enable VNC service
  systemd:
    name: vncserver@1.service
    state: started
    enabled: yes
    daemon_reload: yes