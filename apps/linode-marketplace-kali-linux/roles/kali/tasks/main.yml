---
- name: Add non-free repository
  apt_repository:
    repo: deb http://http.kali.org/kali kali-rolling main contrib non-free non-free-firmware
    state: present
    filename: kali-nonfree

- name: Update apt cache
  apt:
    update_cache: yes

- name: Install firmware-misc-nonfree
  apt:
    name: firmware-misc-nonfree
    state: present
    update_cache: yes
  environment:
    DEBIAN_FRONTEND: noninteractive

- name: Debug kali_package variable
  debug:
    var: kali_package

- name: Fix broken packages
  apt:
    clean: true
    autoclean: true
    autoremove: true
  environment:
    DEBIAN_FRONTEND: noninteractive

#- name: Install Kali Linux
#  apt:
#    name: "{{ kali_package }}"
#    state: present
#    dpkg_options: 'force-confdef,force-confold'
#  environment:
#    DEBIAN_FRONTEND: noninteractive
#  when: kali_package is defined

- name: Install Kali Linux
  apt:
    name: "{{ kali_package }}"
    state: present
  when: kali_package is defined

#- name: Set up VNC
#  include_tasks: vnc_setup.yml
#  when: vnc_enabled | bool