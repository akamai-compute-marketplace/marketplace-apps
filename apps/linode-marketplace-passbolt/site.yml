---
- name: Passbolt deploy
  hosts: localhost
  connection: local
  any_errors_fatal: true
  user: root
  vars_files:
    - group_vars/linode/vars

  tasks:
    - block:
        - name: Run roles
          include_role:
            name: "{{ item }}"
          loop:
            - common
            - passbolt
            - post
        - name: Deployment passed
          import_tasks: ../linode_helpers/roles/cilog/tasks/main.yml
          vars:
            deploy_status: 'successful'
      rescue:
        - name: Deployment failed
          import_tasks: ../linode_helpers/roles/cilog/tasks/main.yml
          vars:
            deploy_status: 'failed'
      when: "mode == 'staging'"

    - name: Running app normally
      include_role:
        name: "{{ item }}"
      loop:
        - common
        - passbolt
        - post
      when: "mode == 'production'"