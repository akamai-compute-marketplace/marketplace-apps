---
- name: Run AzuraCast setup-release
  command: ./docker.sh setup-release
  args:
    chdir: /var/azuracast

- name: Run AzuraCast install
  command: ./docker.sh install
  args:
    chdir: /var/azuracast

- name: Wait for AzuraCast web container to be up
  shell: |
    docker ps --format '{{'{{'}}.Names{{'}}'}}' | grep -q '^azuracast$'
  register: azuracast_container
  retries: 10
  delay: 10
  until: azuracast_container.rc == 0
  changed_when: false

# - name: Wait for 1 minute to make sure mysql is ready
#   pause:
#     seconds: 60

- name: Wait for MySQL to be ready in AzuraCast container (using /dev/tcp)
  shell: |
    docker exec azuracast bash -c "echo > /dev/tcp/localhost/3306"
  register: mysql_ready
  retries: 20
  delay: 5
  until: mysql_ready.rc == 0
  changed_when: false

- name: Get AzuraCast DB password from env file
  slurp:
    src: /var/azuracast/azuracast.env
  register: azuracast_env

- name: Set DB password fact
  set_fact:
    azuracast_db_password: "{{ (azuracast_env.content | b64decode).split('\n') | select('match', '^MYSQL_PASSWORD=') | list | first | regex_replace('^MYSQL_PASSWORD=', '') }}"

- name: Copy AzuraCast admin user creation script to host
  template:
    src: db_create_user.php.j2
    dest: /var/azuracast/db_create_user.php
    mode: '0644'
    owner: "{{ username }}"
    group: "{{ username }}"

- name: Copy admin user creation script into container
  command: docker cp /var/azuracast/db_create_user.php azuracast:/var/azuracast/www/db_create_user.php

- name: Run admin user creation script in container
  command: docker exec -u azuracast azuracast php /var/azuracast/www/db_create_user.php

- name: Wait for Redis socket in container
  command: docker exec azuracast test -S /run/redis/redis.sock
  register: redis_socket_check
  retries: 10
  delay: 5
  until: redis_socket_check.rc == 0
  changed_when: false

- name: Set super admin user with AzuraCast CLI
  command: docker exec azuracast azuracast_cli azuracast:account:set-administrator {{ azuracast_admin_email }}

- name: Restart AzuraCast container
  command: docker restart azuracast

- name: Wait for AzuraCast container to be up after restart
  shell: |
    docker ps --format '{{'{{'}}.Names{{'}}'}}' | grep -q '^azuracast$'
  register: azuracast_container_restart
  retries: 10
  delay: 10
  until: azuracast_container_restart.rc == 0
  changed_when: false

# - name: Wait for 1 minute to make sure mysql is ready
#   pause:
#     seconds: 60

- name: Wait for MySQL to be ready in AzuraCast container (using /dev/tcp)
  shell: |
    docker exec azuracast bash -c "echo > /dev/tcp/localhost/3306"
  register: mysql_ready
  retries: 20
  delay: 5
  until: mysql_ready.rc == 0
  changed_when: false
  
- name: Set up Let's Encrypt certificate with AzuraCast CLI
  command: docker exec azuracast azuracast_cli azuracast:acme:get-certificate
  register: acme_renew_result
  ignore_errors: true

- name: Show Let's Encrypt CLI output
  debug:
    var: acme_renew_result.stdout_lines
