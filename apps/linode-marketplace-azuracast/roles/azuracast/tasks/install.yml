---
- name: Run AzuraCast setup-release
  command: ./docker.sh setup-release
  args:
    chdir: /var/azuracast

- name: Run AzuraCast install
  command: ./docker.sh install
  args:
    chdir: /var/azuracast

# - name: Wait for AzuraCast web container to be up
#   shell: |
#     docker ps --format '{{'{{'}}.Names{{'}}'}}' | grep -q '^azuracast$'
#   register: azuracast_container
#   retries: 10
#   delay: 10
#   until: azuracast_container.rc == 0
#   changed_when: false

# - name: Get AzuraCast DB password from env file
#   slurp:
#     src: /var/azuracast/azuracast.env
#   register: azuracast_env

# - name: Set DB password fact
#   set_fact:
#     azuracast_db_password: "{{ (azuracast_env.content | b64decode).split('\n') | select('match', '^MYSQL_PASSWORD=') | list | first | regex_replace('^MYSQL_PASSWORD=', '') }}"

# - name: Template AzuraCast admin user creation script
#   template:
#     src: db_create_user.php.j2
#     dest: /var/azuracast/db_create_user.php
#     mode: '0644'
#     owner: "{{ username }}"
#     group: "{{ username }}"

# - name: Check for db_create_user.php on host
#   stat:
#     path: /var/azuracast/db_create_user.php
#   register: db_create_user_php_stat

# - name: Debug host db_create_user.php stat
#   debug:
#     var: db_create_user_php_stat

# - name: Copy admin user creation script into container
#   command: docker cp /var/azuracast/db_create_user.php azuracast:/var/azuracast/www/db_create_user.php

# - name: Check for db_create_user.php in container
#   command: docker exec azuracast ls -l /var/azuracast/www/db_create_user.php
#   register: container_db_create_user_php_check
#   ignore_errors: true

# - name: Debug container db_create_user.php check
#   debug:
#     var: container_db_create_user_php_check

# - name: Run admin user creation script in container
#   command: docker exec -u azuracast azuracast php /var/azuracast/www/db_create_user.php

# - name: Restart AzuraCast container
#   command: docker restart azuracast

# - name: Trigger Let's Encrypt certificate issuance via AzuraCast CLI
#   command: docker exec azuracast php /var/azuracast/www/bin/console azuracast:acme:renew
#   register: acme_renew_result
#   ignore_errors: true

# - name: Show Let's Encrypt CLI output
#   debug:
#     var: acme_renew_result.stdout_lines
