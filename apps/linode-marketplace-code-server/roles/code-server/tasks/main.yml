---
- name: install required packages
  apt:
    pkg:
      - nginx
      - curl
      - git
    state: latest
    update_cache: true

# code-server
- name: download code-server .deb package
  get_url:
    url: "{{ code_download_link }}"
    dest: "/tmp/code-server_{{ code_server_version }}_amd64.deb"

- name: install code-server .deb package
  apt:
    deb: "/tmp/code-server_{{ code_server_version }}_amd64.deb"
    state: present

- name: enable and start code-server service
  systemd:
    name: "code-server@{{ username }}"
    enabled: yes
    state: started

# Nginx
- name: install nginx
  apt:
    pkg:
      - nginx
    state: present

- name: config file setup
  template:
    src: templates/nginx.conf.j2
    dest: "/etc/nginx/sites-available/{{ _domain }}"    

- name: create a symbolic link for the nginx configuration
  file:
    src: "/etc/nginx/sites-available/{{ _domain }}"
    dest: "/etc/nginx/sites-enabled/{{ _domain }}"
    state: link

- name: unlink the default nginx configuration
  file:
    path: "/etc/nginx/sites-enabled/default"
    state: absent
  notify: reload nginx service


