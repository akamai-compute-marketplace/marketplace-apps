---
# install system packages

- name: install required packages
  apt:
    pkg:
      - curl
      - htop
      - ca-certificates
      - tzdata
      - perl
      - gnupg
      - apt-transport-https
    state: latest
    update_cache: true

- name: add gitLab package repository install
  shell: curl -fsSL https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | bash
  args:
    executable: /bin/bash

- name: install gitlab
  apt:
    name: gitlab-ce
    state: latest
    update_cache: yes

- name: configure gitlab
  template:
    src: gitlab.rb.j2
    dest: /etc/gitlab/gitlab.rb

- name: reconfigure gitlab
  shell: gitlab-ctl reconfigure
  async: 600
  poll: 10

- name: obtain default password
  slurp:
    src: /etc/gitlab/initial_root_password
  register: gitlab_password
  no_log: true

- name: extract the password using regex
  set_fact:
    gitlab_root_password: "{{ gitlab_password['content'] | b64decode | regex_findall('Password: (.+)') | first }}"
  no_log: true

- name: disable gitlab user signups
  command: >
    gitlab-rails runner 'ApplicationSetting.find_by(id: 1)&.update!(signup_enabled: false)'
  become: yes
  become_user: git