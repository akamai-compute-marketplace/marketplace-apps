---
# install system packages

- name: install required packages
  apt:
    pkg:
      - curl
      - htop
      - ca-certificates
      - tzdata
      - perl
      - gnupg
      - apt-transport-https
    state: latest
    update_cache: true

- name: download gitLab install script
  get_url:
    url: https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh
    dest: /tmp/gitlab_script.sh
    mode: '0755'

- name: run gitLab install script
  command: bash /tmp/gitlab_script.sh

- name: install gitlab
  apt:
    name: gitlab-ce
    state: latest
    update_cache: true

- name: configure gitlab
  template:
    src: gitlab.rb.j2
    dest: /etc/gitlab/gitlab.rb

- name: reconfigure gitlab
  command: gitlab-ctl reconfigure
  async: 600
  poll: 10

- name: obtain default password
  slurp:
    src: /etc/gitlab/initial_root_password
  register: gitlab_password
  no_log: true

- name: extract the password using regex
  set_fact:
    gitlab_root_password: "{{ gitlab_password['content'] | b64decode | regex_findall('Password: (.+)') | first }}"
  no_log: true

- name: disable gitlab user signups
  command: >
    gitlab-rails runner 'ApplicationSetting.find_by(id: 1)&.update!(signup_enabled: false)'
  become: yes
  become_user: git