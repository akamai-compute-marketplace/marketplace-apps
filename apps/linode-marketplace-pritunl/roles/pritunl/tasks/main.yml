---
- name: add mongodb repository
  apt_repository:
    repo: "deb [ signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg ] https://repo.mongodb.org/apt/ubuntu noble/mongodb-org/8.0 multiverse"
    state: present
    filename: mongodb-org

- name: add openvpn repository
  apt_repository:
    repo: "deb [ signed-by=/usr/share/keyrings/openvpn-repo.gpg ] https://build.openvpn.net/debian/openvpn/stable noble main"
    state: present
    filename: openvpn

- name: add pritunl repository
  apt_repository:
    repo: "deb [ signed-by=/usr/share/keyrings/pritunl.gpg ] https://repo.pritunl.com/stable/apt noble main"
    state: present
    filename: pritunl

- name: install gnupg
  apt:
    name: gnupg
    state: present

- name: add mongodb gpg key
  get_url:
    url: https://www.mongodb.org/static/pgp/server-8.0.asc
    dest: /tmp/mongodb-server-8.0.asc

- name: decrypt and store mongodb gpg key
  shell: gpg --dearmor --yes -o /usr/share/keyrings/mongodb-server-8.0.gpg /tmp/mongodb-server-8.0.asc

- name: add openvpn gpg key
  get_url:
    url: https://swupdate.openvpn.net/repos/repo-public.gpg
    dest: /tmp/openvpn-repo.gpg

- name: decrypt and store openvpn gpg key
  shell: gpg --dearmor --yes -o /usr/share/keyrings/openvpn-repo.gpg /tmp/openvpn-repo.gpg

- name: add pritunl gpg key
  get_url:
    url: https://raw.githubusercontent.com/pritunl/pgp/master/pritunl_repo_pub.asc
    dest: /tmp/pritunl_repo_pub.asc

- name: decrypt and store pritunl gpg key
  shell: gpg --dearmor --yes -o /usr/share/keyrings/pritunl.gpg /tmp/pritunl_repo_pub.asc

- name: apt update
  apt:
    update_cache: yes

- name: install required packages
  apt:
    name:
      - pritunl
      - openvpn
      - mongodb-org
      - wireguard
      - wireguard-tools
      - nginx
    state: present

- name: update pritunl conf
  template:
      src: 'templates/pritunl.conf.j2'
      dest: '/etc/pritunl.conf'

- name: start and enable pritunl
  systemd:
    name: pritunl
    state: started
    enabled: yes

- name: start and enable mongodb
  systemd:
    name: mongod
    state: started
    enabled: yes
  
# ssl_certbot
- name: setting up ssl certificate
  import_role:
    name: certbot_ssl


