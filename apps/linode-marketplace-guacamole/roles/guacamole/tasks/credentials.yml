---
# - name: Create password update script
#   template:
#     src: update-guacamole-password.sh.j2
#     dest: "{{ guacamole_base_dir }}/update-guacamole-password.sh"
#     mode: '0755'
#     owner: root
#     group: root

# - name: Set initial Guacamole admin password
#   command: ./update-guacamole-password.sh "{{ guacamole_admin_password }}"
#   args:
#     chdir: "{{ guacamole_base_dir }}"
#   register: password_update_result
#   failed_when: password_update_result.rc != 0
#   no_log: true

- name: Generate password salt for Guacamole admin user
  set_fact:
    guacamole_password_salt: "{{ lookup('password', '/dev/null length=32 chars=hex') }}"

- name: Debug - Show generated salt
  debug:
    msg: "Generated salt: {{ guacamole_password_salt }}"

- name: Generate password hash for Guacamole admin user
  set_fact:
    guacamole_password_hash: "{{ (guacamole_admin_password ~ guacamole_password_salt | upper) | hash('sha256') }}"

- name: Debug - Show generated hash
  debug:
    msg: "Generated hash: {{ guacamole_password_hash }}"

- name: Update Guacamole admin password in database
  community.postgresql.postgresql_query:
    login_host: localhost
    login_user: "{{ postgres_user_name }}"
    login_password: "{{ postgres_user_password }}"
    db: "{{ postgres_db_name }}"
    query: >
      UPDATE guacamole_user 
      SET password_hash = decode(%s, 'hex'),
          password_salt = decode(%s, 'hex'),
          password_date = CURRENT_TIMESTAMP
      WHERE user_id = 1
    positional_args:
      - "{{ guacamole_password_hash }}"
      - "{{ guacamole_password_salt }}"
  no_log: true

- name: Debug - Verify database update
  community.postgresql.postgresql_query:
    login_host: localhost
    login_user: "{{ postgres_user_name }}"
    login_password: "{{ postgres_user_password }}"
    db: "{{ postgres_db_name }}"
    query: >
      SELECT 
        username,
        encode(password_hash, 'hex') as password_hash_hex,
        encode(password_salt, 'hex') as password_salt_hex,
        password_date
      FROM guacamole_user 
      WHERE user_id = 1
  register: db_password_result

- name: Debug - Show database values after update
  debug:
    msg: 
      - "Database user: {{ db_password_result.query_result[0].username }}"
      - "Database password hash: {{ db_password_result.query_result[0].password_hash_hex }}"
      - "Database password salt: {{ db_password_result.query_result[0].password_salt_hex }}"
      - "Password date: {{ db_password_result.query_result[0].password_date }}"
