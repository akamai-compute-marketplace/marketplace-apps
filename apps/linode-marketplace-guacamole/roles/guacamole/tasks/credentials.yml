---
- name: Generate password salt for Guacamole admin user
  set_fact:
    guacamole_password_salt: "{{ lookup('password', '/dev/null length=32 chars=0123456789abcdef') }}"

- name: Generate password hash for Guacamole admin user
  set_fact:
    guacamole_password_hash: "{{ (guacamole_admin_password ~ guacamole_password_salt | upper) | hash('sha256') }}"

- name: Update Guacamole admin password in database
  community.docker.docker_container_exec:
    container: guac_postgres
    command: >
      psql -U {{ postgres_user_name }} -d {{ postgres_db_name }} -c
      "UPDATE guacamole_user 
       SET password_hash = decode('{{ guacamole_password_hash }}', 'hex'),
           password_salt = decode('{{ guacamole_password_salt }}', 'hex'),
           password_date = CURRENT_TIMESTAMP
       WHERE user_id = 1;"
    env:
      PGPASSWORD: "{{ postgres_user_password }}"
  no_log: true