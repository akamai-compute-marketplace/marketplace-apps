---
# - name: Create password update script
#   template:
#     src: update-guacamole-password.sh.j2
#     dest: "{{ guacamole_base_dir }}/update-guacamole-password.sh"
#     mode: '0755'
#     owner: root
#     group: root

# - name: Set initial Guacamole admin password
#   command: ./update-guacamole-password.sh "{{ guacamole_admin_password }}"
#   args:
#     chdir: "{{ guacamole_base_dir }}"
#   register: password_update_result
#   failed_when: password_update_result.rc != 0
#   no_log: true

- name: Generate password salt for Guacamole admin user
  set_fact:
    guacamole_password_salt: "{{ lookup('password', '/dev/null length=32 chars=hex') }}"

##########################################
- name: Debug - Show generated salt
  debug:
    msg: "Generated salt: {{ guacamole_password_salt }}"
##########################################

- name: Generate password hash for Guacamole admin user
  set_fact:
    guacamole_password_hash: "{{ (guacamole_admin_password ~ guacamole_password_salt | upper) | hash('sha256') }}"

##########################################
- name: Debug - Show generated hash
  debug:
    msg: "Generated hash: {{ guacamole_password_hash }}"
##########################################

- name: Update Guacamole admin password in database
  community.docker.docker_container_exec:
    container: guac_postgres
    command: >
      psql -U {{ postgres_user_name }} -d {{ postgres_db_name }} -c
      "UPDATE guacamole_user 
       SET password_hash = decode('{{ guacamole_password_hash }}', 'hex'),
           password_salt = decode('{{ guacamole_password_salt }}', 'hex'),
           password_date = CURRENT_TIMESTAMP
       WHERE user_id = 1;"
    env:
      PGPASSWORD: "{{ postgres_user_password }}"
#  no_log: true

##########################################
- name: Debug - Verify database update
  community.docker.docker_container_exec:
    container: guac_postgres
    command: >
      psql -U {{ postgres_user_name }} -d {{ postgres_db_name }} -t -c
      "SELECT 
        'Username: ' || COALESCE((SELECT name FROM guacamole_entity WHERE entity_id = guacamole_user.entity_id), 'N/A') ||
        ', Hash: ' || encode(password_hash, 'hex') ||
        ', Salt: ' || encode(password_salt, 'hex') ||
        ', Date: ' || password_date::text
       FROM guacamole_user 
       WHERE user_id = 1;"
    env:
      PGPASSWORD: "{{ postgres_user_password }}"
  register: db_password_result

- name: Debug - Show database values after update
  debug:
    msg: "{{ db_password_result.stdout_lines }}"
##########################################