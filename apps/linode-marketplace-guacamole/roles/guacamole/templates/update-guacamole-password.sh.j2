#!/bin/bash
# Apache Guacamole Password Update Script
# Usage: ./update-guacamole-password.sh <new_password>
# Generated admin password: {{ guacamole_admin_password }}

set -e

if [ $# -ne 1 ]; then
    echo "Usage: $0 <new_password>"
    echo "Example: $0 MySecurePassword123"
    exit 1
fi

NEW_PASSWORD="$1"

echo "Updating Guacamole admin password..."

# Generate new salt (32 random bytes as hex)
NEW_SALT=$(python3 -c "import secrets; print(secrets.token_hex(32))")

# Generate password hash using Guacamole algorithm: SHA256(password + UPPERCASE_SALT)
NEW_HASH=$(python3 -c "
import hashlib
password = '$NEW_PASSWORD'
salt_hex = '$NEW_SALT'.upper()
combined = password + salt_hex
hash_result = hashlib.sha256(combined.encode('utf-8')).hexdigest()
print(hash_result)
")

echo "Generated new salt: $NEW_SALT"
echo "Generated new hash: $NEW_HASH"

# Update database
docker compose exec postgres psql -U guacamole_user -d guacamole_db -c "
UPDATE guacamole_user 
SET password_hash = decode('$NEW_HASH', 'hex'),
    password_salt = decode('$NEW_SALT', 'hex'),
    password_date = CURRENT_TIMESTAMP
WHERE user_id = 1;
"

echo "Password updated successfully!"
echo "New credentials:"
echo "  Username: guacadmin"
echo "  Password: $NEW_PASSWORD"
echo ""
echo "Please test the login to verify the update worked."