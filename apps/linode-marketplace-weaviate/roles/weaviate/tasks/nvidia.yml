---
- name: blacklist nouveau driver
  copy:
    dest: /etc/modprobe.d/blacklist-nvidia-nouveau.conf
    content: |
      blacklist nouveau
      options nouveau modeset=0
    mode: '0644'

- name: install ubuntu-drivers-common package
  apt:
    name: ubuntu-drivers-common
    state: present
    update_cache: true

- name: detect recommended nvidia driver version
  shell: ubuntu-drivers devices | grep 'recommended' | awk '{print $3}'
  register: recommended_driver
  changed_when: false

- name: install recommended nvidia driver package
  apt:
    name: "{{ recommended_driver.stdout }}"
    state: present
    update_cache: true

- name: check if gpu is bound to nouveau
  stat:
    path: /sys/bus/pci/devices/0000:00:02.0/driver
  register: gpu_driver_link

- name: get current gpu driver
  shell: readlink /sys/bus/pci/devices/0000:00:02.0/driver | awk -F'/' '{print $NF}'
  register: current_driver
  changed_when: false
  when: gpu_driver_link.stat.exists

- name: unbind gpu from nouveau driver
  shell: echo "0000:00:02.0" > /sys/bus/pci/drivers/nouveau/unbind
  args:
    executable: /bin/bash
  when:
    - gpu_driver_link.stat.exists
    - current_driver.stdout == "nouveau"

- name: unload nouveau module to prevent rebinding
  community.general.modprobe:
    name: nouveau
    state: absent
  when:
    - gpu_driver_link.stat.exists
    - current_driver.stdout == "nouveau"

- name: load nvidia kernel module
  community.general.modprobe:
    name: nvidia
    state: present
  when:
    - gpu_driver_link.stat.exists
    - current_driver.stdout == "nouveau"

- name: bind gpu to nvidia driver
  shell: echo "0000:00:02.0" > /sys/bus/pci/drivers/nvidia/bind
  args:
    executable: /bin/bash
  when:
    - gpu_driver_link.stat.exists
    - current_driver.stdout == "nouveau"

- name: load nvidia-uvm module for cuda support
  community.general.modprobe:
    name: nvidia_uvm
    state: present

- name: add nvidia container toolkit repository gpg key
  get_url:
    url: https://nvidia.github.io/libnvidia-container/gpgkey
    dest: /usr/share/keyrings/nvidia-container-toolkit-keyring.asc
    mode: '0644'

- name: add nvidia container toolkit repository
  apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.asc] https://nvidia.github.io/libnvidia-container/stable/deb/amd64 /"
    filename: nvidia-container-toolkit
    state: present
    update_cache: true

- name: install nvidia container toolkit
  apt:
    name: nvidia-container-toolkit
    state: present

- name: configure docker to use nvidia runtime
  command: nvidia-ctk runtime configure --runtime=docker
  notify: restart docker