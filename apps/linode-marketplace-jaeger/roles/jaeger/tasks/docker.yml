---
- name: Create Docker volume for Jaeger data
  community.docker.docker_volume:
    name: jaeger_data

- name: Run Jaeger All-in-One container
  community.docker.docker_container:
    name: jaeger
    image: "jaegertracing/all-in-one:{{ jaeger_version }}"
    state: started
    restart_policy: unless-stopped
    ports:
      - "16686:16686"   # Jaeger UI (reverse proxied with basic htpasswd auth)
      - "4317:4317"     # OTLP gRPC receiver (mTLS secured)
      - "4318:4318"     # OTLP HTTP receiver (mTLS secured)
    env:
      COLLECTOR_OTLP_ENABLED: "true"
      # TLS configuration for OTLP gRPC endpoint
      COLLECTOR_OTLP_GRPC_TLS_ENABLED: "true"
      COLLECTOR_OTLP_GRPC_TLS_CERT: "{{ jaeger_tls_dir }}/server-cert.pem"
      COLLECTOR_OTLP_GRPC_TLS_KEY: "{{ jaeger_tls_dir }}/server-key.pem"
      COLLECTOR_OTLP_GRPC_TLS_CLIENT_CA: "{{ jaeger_tls_dir }}/ca-cert.pem"
      # TLS configuration for OTLP HTTP endpoint  
      COLLECTOR_OTLP_HTTP_TLS_ENABLED: "true"
      COLLECTOR_OTLP_HTTP_TLS_CERT: "{{ jaeger_tls_dir }}/server-cert.pem"
      COLLECTOR_OTLP_HTTP_TLS_KEY: "{{ jaeger_tls_dir }}/server-key.pem"
      COLLECTOR_OTLP_HTTP_TLS_CLIENT_CA: "{{ jaeger_tls_dir }}/ca-cert.pem"
    volumes:
      - jaeger_data:/tmp
      - "{{ jaeger_tls_dir }}:{{ jaeger_tls_dir }}:ro"  # Mount TLS certificates
    log_driver: json-file
    log_options:
      max-size: "10m"
      max-file: "3"