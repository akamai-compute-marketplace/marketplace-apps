# Linode NATS Deployment One-Click APP

App description

NATS is a connective technology built for the hyper-connected world. 
It is a single technology that enables applications to securely communicate 
across any combination of cloud vendors, on-premise, edge, web and mobile, and devices.
NATS consists of a family of open-source products that are tightly integrated but 
can be deployed easily and independently. NATS is being used globally by thousands of companies, 
spanning use-cases including microservices, edge computing, mobile, and IoT.

Support - https://natsio.slack.com/

Installation examples - https://docs.nats.io/running-a-nats-service/introduction/installation

Sample code/Tutorials - https://natsbyexample.com/

Latest version - https://github.com/nats-io/nats-server

## Software Included

| Software  | Version   | Description   |
| :---      | :----     | :---          |
| nats-server | According to specified version | Highly performant, open-source messaging system |
| Nginx | 1.18 | Open Source web server |

**Supported Distributions:**

- Ubuntu 22.04 LTS

## Linode Helpers Included

| Name  | Action  |
| :---  | :---    |
| Hostname   | The Hostname module uses `dnsdomainname -A` to detect the Linode's FQDN and write to the `/etc/hosts` file. This defaults to the Linode's automatically assigned rDNS. To use a custom FQDN see [Configure your Linode for Reverse DNS](https://www.linode.com/docs/guides/configure-your-linode-for-reverse-dns/).  |
| Update Packages   | The Update Packages module performs apt update and upgrade actions as root.  |
| UFW   | The UFW module will utilize a list generated by `linode_helpers/ufw/ufwgen.yml` in the `group_vars/linode/vars` and enables the service.  |
| Fail2Ban   | The Fail2Ban module installs, activates and enables the Fail2Ban service.  |

## Use our API

Customers can choose to the deploy the Focalboard app through the Linode Marketplace or directly using API. Before using the commands below, you will need to create an [API token](https://www.linode.com/docs/products/tools/linode-api/get-started/#create-an-api-token) or configure [linode-cli](https://www.linode.com/products/cli/) on an environment.

Make sure that the following values are updated at the top of the code block before running the commands:
- TOKEN
- ROOT_PASS

SHELL:
```
export TOKEN="YOUR API TOKEN"
export ROOT_PASS="aComplexP@ssword"
export SOA_EMAIL_ADDRESS="email@domain.com"
export NAME="nats_server_name"
export VERSION="nats_server_name"
export SYSTEM_USER_PASSWORD="nats_system_user_pass"
export EXAMPLE_USER_PASSWORD="example_system_user_pass"
export NATS_PORT="nats port" //default is 4222
export WEBSOCKET_PORT="websocket port" //default is 8888
export MQTT_PORT="mqtt port" //default is 1883

curl -H "Content-Type: application/json" \
    -H "Authorization: Bearer ${TOKEN}" \
    -X POST -d '{
      "backups_enabled": true,
      "swap_size": 512,
      "image": "linode/ubuntu2204",
      "root_pass": "${ROOT_PASS}",
      "stackscript_id": 00000000000,
      "stackscript_data": {
        "soa_email_address": "${SOA_EMAIL_ADDRESS}",
        "name": "${NAME}",
        "version": "${VERSION}",
        "system_user_password": "${SYSTEM_USER_PASSWORD}",
        "example_user_password": "${EXAMPLE_USER_PASSWORD}",
        "nats_port": "${NATS_PORT}",
        "websocket_port": "${WEBSOCKET_PORT}",
        "mqtt_port": "${MQTT_PORT}",
      },
      "authorized_users": [
        "myUser",
        "secondaryUser"
      ],
      "booted": true,
      "label": "linode123",
      "type": "g6-standard-2",
      "region": "us-east",
      "group": "Linode-Group"
    }' \
https://api.linode.com/v4/linode/instances
```

CLI:
```
export TOKEN="YOUR API TOKEN"
export ROOT_PASS="aComplexP@ssword"
export SOA_EMAIL_ADDRESS="email@domain.com"
export NAME="nats_server_name"
export VERSION="nats_server_name"
export SYSTEM_USER_PASSWORD="nats_system_user_pass"
export EXAMPLE_USER_PASSWORD="example_system_user_pass"
export NATS_PORT="nats port" //default is 4222
export WEBSOCKET_PORT="websocket port" //default is 8888
export MQTT_PORT="mqtt port" //default is 1883

linode-cli linodes create \
  --label linode123 \
  --root_pass ${ROOT_PASS} \
  --booted true \
  --stackscript_id 00000000000 \
  --stackscript_data '{"soa_email_address": "${SOA_EMAIL_ADDRESS}"}', \
 '{"name": "${NAME}"}', \
 '{"version": "${VERSION}"}', \
 '{"system_user_password": "${SYSTEM_USER_PASSWORD}"}', \
 '{"example_user_password": "${EXAMPLE_USER_PASSWORD}"}', \
 '{"nats_port": "${NATS_PORT}"}', \
 '{"websocket_port": "${WEBSOCKET_PORT}"}', \
 '{"mqtt_port": "${MQTT_PORT}"} \ 
  --region us-east \
  --type g6-standard-2 \
  --authorized_keys "ssh-rsa AAAA_valid_public_ssh_key_123456785== user@their-computer"
  --authorized_users "myUser"
  --authorized_users "secondaryUser"
```

## Resources

- [Create Linode via API](https://www.linode.com/docs/api/linode-instances/#linode-create)
- [Stackscript referece](https://www.linode.com/docs/guides/writing-scripts-for-use-with-linode-stackscripts-a-tutorial/#user-defined-fields-udfs)

