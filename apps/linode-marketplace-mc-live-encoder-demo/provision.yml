---
# mc-live-encoder-demo
- name: Setting up environment
  hosts: localhost
  connection: local
  any_errors_fatal: true
  user: root
  vars_files: [group_vars/linode/vars]
  tasks:
    - name: Generating sudo user password
      set_fact:
        password: "{{ lookup('password', '/dev/null length=25 chars=ascii_letters,digits') }}"

    - name: Writing sudo user password to vars
      blockinfile:
        insertafter: EOF
        path: group_vars/linode/vars
        block: |
          password: {{ password }}

    # set customer supplied sudo user, password and SSH keys
    - name: Set sudo user
      user:
        name: "{{ username }}"
        shell: /bin/bash
        groups: wheel
        password: "{{ password | password_hash('sha512') }}"
        update_password: on_create
        expires: -1
        append: true
        generate_ssh_key: true
        ssh_key_bits: 4096
        ssh_key_file: .ssh/id_rsa
        state: present
