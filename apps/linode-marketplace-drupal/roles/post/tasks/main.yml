---
# Final system configurations and cleanup
- name: Ensure services are started and enabled
  service:
    name: "{{ item }}"
    state: started
    enabled: yes
  loop:
    - apache2
    - mariadb
    - "php8.3-fpm"

- name: restart Apache2
  systemd:
    name: apache2.service
    state: restarted

- name: Install certbot for SSL
  apt:
    name:
      - certbot
      - python3-certbot-apache
    state: present
- name: configuring domain with certbot
  import_role:
    name: certbot_ssl
  when: default_dns is not defined

- name: Set up MOTD
  template:
    src: motd.j2
    dest: /etc/motd
    owner: root
    group: root
    mode: '0644'

- name: writing sudo creds into file
  copy:
    dest: '/home/{{ username }}/.credentials'
    mode: '0600'
    owner: '{{ username }}'
    group: '{{ username }}'
    content: |
      Sudo Username: {{ username }}
      Sudo Password: {{ password }}
      MariaDB database name: drupaldb
      MariaDB username: drupal
      MariaDB root password: {{ mysql_root_password }}

- name: Clean up temporary files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/drupal.tar.gz 