---
- name: Check if Drupal is already installed
  command: /var/www/drupal/vendor/bin/drush status --field=bootstrap
  args:
    chdir: /var/www/drupal/web
  register: drupal_status
  changed_when: false
  failed_when: false
  become: yes
  become_user: www-data

- name: Install Drupal using Drush
  command:
    cmd: >
      /var/www/drupal/vendor/bin/drush site:install standard
      --db-url=mysql://drupal:{{ mysql_drupal_password }}@localhost/drupaldb
      --site-name="{{ site_name }}"
      --site-mail="{{ site_email }}"
      --account-name="{{ admin_username }}"
      --account-pass="{{ admin_password }}"
      --account-mail="{{ site_email }}"
      --locale="en"
      --yes
  args:
    chdir: /var/www/drupal/web
  become: yes
  become_user: www-data
  when: drupal_status.stdout != "Successful"
  register: drupal_install

- name: Set required Drupal states
  command: "{{ item }}"
  args:
    chdir: /var/www/drupal/web
  with_items:
    - "/var/www/drupal/vendor/bin/drush state:set system.install_time $(date +%s)"
    - "/var/www/drupal/vendor/bin/drush state:set system.install_profile standard"
    - "/var/www/drupal/vendor/bin/drush state:set system.install_profile.locked 1"
    - "/var/www/drupal/vendor/bin/drush state:set install_task finished"
    - "/var/www/drupal/vendor/bin/drush cache:rebuild"
  become: yes
  become_user: www-data
  when: drupal_install.changed

- name: Configure timezone
  command: /var/www/drupal/vendor/bin/drush config:set system.date timezone.default UTC -y
  args:
    chdir: /var/www/drupal/web
  become: yes
  become_user: www-data
  when: drupal_status.stdout != "Successful"

- name: Enable update module
  command: /var/www/drupal/vendor/bin/drush pm:enable update -y
  args:
    chdir: /var/www/drupal/web
  become: yes
  become_user: www-data
  when: drupal_status.stdout != "Successful"

- name: Configure update notification email
  command: /var/www/drupal/vendor/bin/drush config:set update.settings notification.emails.0 {{ site_email }} -y
  args:
    chdir: /var/www/drupal/web
  become: yes
  become_user: www-data
  when: drupal_status.stdout != "Successful"

- name: Configure update check interval
  command: /var/www/drupal/vendor/bin/drush config:set update.settings check.interval_days 1 -y
  args:
    chdir: /var/www/drupal/web
  become: yes
  become_user: www-data
  when: drupal_status.stdout != "Successful"

- name: Ensure default directory has correct permissions
  file:
    path: /var/www/drupal/web/sites/default
    owner: www-data
    group: www-data
    mode: '0755'  # temporarily allow write for owner
  become: yes

- name: Set trusted host patterns in settings.php
  lineinfile:
    path: /var/www/drupal/web/sites/default/settings.php
    line: |
      $settings['trusted_host_patterns'] = ['^localhost$', '^127\.0\.0\.1$', '^\[::1\]$', '^{{ _domain | replace('.', '\\.') }}$', '^.*\.ip\.linodeusercontent\.com$'];
    insertafter: EOF
  become: yes
  become_user: www-data

- name: Reset default directory permissions
  file:
    path: /var/www/drupal/web/sites/default
    owner: www-data
    group: www-data
    mode: '0664'
  become: yes

- name: Display settings.php content
  command: cat /var/www/drupal/web/sites/default/settings.php
  register: settings_content
  changed_when: false
  become: yes
  become_user: www-data

- name: Debug settings.php
  debug:
    var: settings_content.stdout

- name: Verify Drupal installation status
  command: /var/www/drupal/vendor/bin/drush status
  args:
    chdir: /var/www/drupal/web
  register: drupal_final_status
  changed_when: false
  become: yes
  become_user: www-data

- name: Debug Drupal status
  debug:
    var: drupal_final_status.stdout_lines

- name: Ensure hash_salt is set in settings.php
  lineinfile:
    path: /var/www/drupal/web/sites/default/settings.php
    line: "$settings['hash_salt'] = '{{ lookup('password', '/dev/null chars=ascii_letters,digits length=55') }}';"
    insertafter: EOF
  become: yes
  become_user: www-data

- name: Mark installation profile as complete
  command: /var/www/drupal/vendor/bin/drush state:set system.install_profile.locked 1
  args:
    chdir: /var/www/drupal/web
  become: yes
  become_user: www-data

- name: Set install_profile in settings.php
  lineinfile:
    path: /var/www/drupal/web/sites/default/settings.php
    line: "$settings['install_profile'] = 'standard';"
    insertafter: EOF
  become: yes
  become_user: www-data