---
# openlitespeed
- name: Download install scripts
  ansible.builtin.get_url:
    url: "{{ item.url }}"
    dest: "{{ item.dest }}"
    mode: '0755'
  loop:
    - { url: 'https://raw.githubusercontent.com/litespeedtech/ls-cloud-image/master/Setup/wpimgsetup.sh', dest: '/tmp/wpimgsetup.sh' }
    - { url: 'https://raw.githubusercontent.com/litespeedtech/ls-cloud-image/master/Cloud-init/per-instance.sh', dest: '/tmp/per-instance.sh' }

- name: Execute install scripts
  ansible.builtin.command:
    cmd: "bash {{ item }}"
  loop:
    - '/tmp/wpimgsetup.sh'
    - '/tmp/per-instance.sh'

- name: get litespeed password
  ansible.builtin.slurp:
    src: '/root/.litespeed_password'
  register: litespeed_password_encode

- name: get db password
  ansible.builtin.slurp:
    src: '/root/.db_password'
  register: db_password_encode

- name: set db & litespeed passwords
  set_fact:
    litespeed_password: "{{ litespeed_password_encode['content'] | b64decode }}"
    db_password: "{{ db_password_encode['content'] | b64decode }}"

- name: Set MySQL root password and WordPress user password
  set_fact:
    root_mysql_pass: "{{ (db_password.split('\n')[0] | regex_replace('.*=\"(.*)\"', '\\1')).strip() }}"
    wordpress_mysql_pass: "{{ (db_password.split('\n')[1] | regex_replace('.*=\"(.*)\"', '\\1')).strip() }}"

- name: configuring admin info
  shell:
    chdir: "/var/www/html"
    cmd: |
      wp core install --allow-root \
          --url="{{ _domain }}" \
          --title="{{ site_title }}" \
          --admin_user="{{ wp_admin_user }}" \
          --admin_email="{{ soa_email_address }}" \
          --admin_password="{{ wp_admin_pass }}" \
          --path="/var/www/html"