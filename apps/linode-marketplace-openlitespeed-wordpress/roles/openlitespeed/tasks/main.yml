---
# openlitespeed

# - name: Download OpenLiteSpeed and Django setup script
#   ansible.builtin.get_url:
#     url: https://raw.githubusercontent.com/litespeedtech/ls-cloud-image/master/Setup/wpimgsetup.sh
#     dest: /tmp/wpimgsetup.sh
#     mode: '0755'

# - name: Install OpenLiteSpeed and Django
#   ansible.builtin.command: bash /tmp/wpimgsetup.sh

# - name: Download script to regenerate password for Web Admin, Database, setup Welcome Message
#   ansible.builtin.get_url:
#     url: https://raw.githubusercontent.com/litespeedtech/ls-cloud-image/master/Cloud-init/per-instance.sh
#     dest: /tmp/per-instance.sh
#     mode: '0755'

# - name: Regenerate password for Web Admin, Database, setup Welcome Message
#   ansible.builtin.command: bash /tmp/per-instance.sh

- name: Download scripts
  ansible.builtin.get_url:
    url: "{{ item.url }}"
    dest: "{{ item.dest }}"
    mode: '0755'
  loop:
    - { url: 'https://raw.githubusercontent.com/litespeedtech/ls-cloud-image/master/Setup/wpimgsetup.sh', dest: '/tmp/wpimgsetup.sh' }
    - { url: 'https://raw.githubusercontent.com/litespeedtech/ls-cloud-image/master/Cloud-init/per-instance.sh', dest: '/tmp/per-instance.sh' }

- name: Execute scripts
  ansible.builtin.command:
    cmd: "bash {{ item }}"
  loop:
    - '/tmp/wpimgsetup.sh'
    - '/tmp/per-instance.sh'

# - name: Slurp Web Admin admin password at /root/.litespeed_password
#   ansible.builtin.slurp:
#     src: /root/.litespeed_password
#   register: litespeed_password_slurped

# - name: Decode Web Admin password from base64
#   set_fact:
#     litespeed_password: "{{ litespeed_password_slurped['content'] | b64decode }}"

# - name: Slurp MySQL root password and MySQL WordPress user password at /root/.db_password
#   ansible.builtin.slurp:
#     src: /root/.db_password
#   register: db_password_slurped

# - name: Decode MySQL passwords from base64
#   set_fact:
#     db_passwords_decoded: "{{ db_password_slurped['content'] | b64decode }}"

# - name: Extract MySQL root password and WordPress user password
#   set_fact:
#     root_mysql_pass: "{{ db_passwords_decoded.split('\n')[0].split('=')[1] | trim }}"
#     wordpress_mysql_pass: "{{ db_passwords_decoded.split('\n')[1].split('=')[1] | trim }}"

- name: Slurp and decode passwords
  ansible.builtin.slurp:
    src: "{{ item.src }}"
  register: slurped_files
  loop:
    - { name: 'litespeed_password', src: '/root/.litespeed_password' }
    - { name: 'db_password', src: '/root/.db_password' }

- name: Decode slurped content
  set_fact:
    "{{ item.item.name }}": "{{ item.content | b64decode }}"
  loop: "{{ slurped_files.results }}"

- name: Extract MySQL root password and WordPress user password
  set_fact:
    root_mysql_pass: "{{ (db_password.split('\n')[0] | regex_replace('.*=\"(.*)\"', '\\1')).strip() }}"
    wordpress_mysql_pass: "{{ (db_password.split('\n')[1] | regex_replace('.*=\"(.*)\"', '\\1')).strip() }}"